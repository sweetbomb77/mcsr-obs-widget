<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SIMGHST Dashboard v1.1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0a0a0f; --card: #0d0d12; --accent: #7d5fff; --win: #00ff88; --loss: #ff4757; --draw: #ffcc00; }
        body { margin: 0; padding: 10px; font-family: 'Outfit', sans-serif; color: white; background: #000; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        
        /* Setup Screen Styling */
        #setup-screen { width: 340px; background: var(--card); padding: 30px; border-radius: 28px; border: 2px solid #1a1a25; text-align: center; margin-top: 50px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #1a1a25; color: white; box-sizing: border-box; font-family: 'Outfit'; }
        button { background: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 900; cursor: pointer; width: 100%; margin-top: 10px; }
        #link-display { margin-top: 20px; padding: 10px; background: #000; border-radius: 8px; font-size: 11px; word-break: break-all; display: none; border: 1px dashed #444; }

        /* Dashboard Styling (Hidden by default) */
        #dashboard { display: none; width: 360px; background: var(--card); border: 2px solid #1a1a25; border-radius: 28px; padding: 20px; box-shadow: 0 15px 40px rgba(0,0,0,1); position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .rank-badge { background: #151520; color: var(--accent); padding: 5px 12px; border-radius: 10px; font-size: 11px; font-weight: 900; border: 1px solid var(--accent); display: flex; align-items: center; gap: 6px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .stat-box { background: #12121a; padding: 12px; border-radius: 16px; border: 1px solid #1c1c25; }
        .label { font-size: 9px; color: #666; text-transform: uppercase; font-weight: 800; }
        .value { font-size: 22px; font-weight: 900; }
        .match-result { background: #111118; border-radius: 20px; padding: 16px; margin-bottom: 15px; border: 1px solid #1c1c25; border-bottom: 4px solid #333; }
        .res-status { text-align: center; font-size: 12px; font-weight: 900; letter-spacing: 3px; margin-bottom: 12px; }
        .vs-container { display: flex; justify-content: space-between; align-items: flex-end; }
        .vs-player { display: flex; flex-direction: column; width: 40%; }
        .p-name { font-size: 16px; font-weight: 800; color: #fff; }
        .p-pb { font-size: 9px; color: #555; font-weight: 700; margin-top: 2px; }
        .ff-label { font-size: 8px; font-weight: 900; color: var(--loss); text-transform: uppercase; opacity: 0; }
        .vs-center { display: flex; flex-direction: column; align-items: center; width: 20%; }
        .finish-time { font-size: 18px; font-weight: 900; margin-top: 2px; }
        .progress-bar { background: #1a1a25; height: 8px; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #a389ff); width: 0%; transition: width 1s; }
        .footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #1a1a25; font-size: 10px; font-weight: 800; color: #333; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h2 style="margin-top:0">Widget Setup</h2>
        <p style="font-size: 12px; color: #888;">Enter your details to generate your OBS link.</p>
        <input type="text" id="setup-user" placeholder="Minecraft Username">
        <input type="text" id="setup-key" placeholder="MCSR Ranked API Key">
        <button onclick="generateLink()">Generate Link</button>
        <div id="link-display"></div>
        <p style="font-size: 10px; color: #555; margin-top: 15px;">Note: Keep your API key private.</p>
    </div>

    <div id="dashboard">
        <div class="header">
            <div class="rank-badge"><span id="rank-icon">â¬›</span> <span id="rank-text">COAL III</span></div>
            <div style="text-align: right;"><div class="label">Peak Elo</div><div id="peak-elo" style="font-size: 14px; font-weight: 900; color: #aaa;">---</div></div>
        </div>
        <div class="stats-grid">
            <div class="stat-box"><div class="label">Elo</div><div id="elo" class="value">---</div></div>
            <div class="stat-box"><div class="label">Win Rate</div><div id="wr" class="value">--%</div></div>
        </div>
        <div id="match-card" class="match-result">
            <div class="res-status" id="res-type">SYNCING</div>
            <div class="vs-container">
                <div class="vs-player">
                    <div id="my-ff" class="ff-label">FORFEITED</div>
                    <span class="p-name" id="my-name" style="color: var(--accent);">---</span>
                    <span class="p-pb" id="my-match-pb">PB: --:--</span>
                </div>
                <div class="vs-center">
                    <div style="font-style:italic; font-weight:900; color:#222; font-size:14px;">VS</div>
                    <div class="finish-time" id="match-finish-time"></div>
                </div>
                <div class="vs-player" style="text-align:right">
                    <div id="opp-ff" class="ff-label">FORFEITED</div>
                    <span class="p-name" id="opp-name">---</span>
                    <span class="p-pb" id="opp-pb">PB: N/A</span>
                </div>
            </div>
        </div>
        <div class="progress-bar"><div id="bar-fill" class="bar-fill"></div></div>
        <div class="footer">
            <span id="record-pill">0W - 0L</span>
            <span>V 1.1.0</span>
        </div>
    </div>

<script>
    const BRIDGE = 'https://script.google.com/macros/s/AKfycbygvsvLV51L7addBEBvIsWTSqg5tVz6vuxaynPcEsb153jYBHThOIgoczuDahk8dn1t/exec';
    
    // 1. URL Parameter Logic
    const urlParams = new URLSearchParams(window.location.search);
    const USER = urlParams.get('user');
    const KEY = urlParams.get('key');

    if (USER && KEY) {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('my-name').innerText = USER;
        startApp();
    }

    function generateLink() {
        const u = document.getElementById('setup-user').value.trim();
        const k = document.getElementById('setup-key').value.trim();
        if(!u || !k) return alert("Please fill in both fields.");
        
        const base = window.location.href.split('?')[0];
        const finalUrl = `${base}?user=${u}&key=${k}`;
        
        const display = document.getElementById('link-display');
        display.style.display = 'block';
        display.innerText = finalUrl;
        alert("Link Generated! Copy the link from the box.");
    }

    // 2. Dashboard Logic
    function formatTime(ms) {
        if (!ms || ms === 0) return "N/A";
        const totalSec = Math.floor(ms / 1000);
        return `${Math.floor(totalSec / 60)}:${(totalSec % 60).toString().padStart(2, '0')}`;
    }

    async function update() {
        const t = new Date().getTime();
        try {
            const pUrl = `https://api.mcsrranked.com/users/${USER}?api_key=${KEY}&t=${t}`;
            const mUrl = `https://api.mcsrranked.com/users/${USER}/matches?count=1&api_key=${KEY}&t=${t}`;
            
            const [pRes, mRes] = await Promise.all([
                fetch(`${BRIDGE}?url=${encodeURIComponent(pUrl)}`).then(r => r.json()),
                fetch(`${BRIDGE}?url=${encodeURIComponent(mUrl)}`).then(r => r.json())
            ]);

            if (pRes.status === "success") {
                const u = pRes.data;
                const s = u.statistics.season;
                document.getElementById('elo').innerText = u.eloRate;
                document.getElementById('peak-elo').innerText = u.seasonPeakElo || u.eloRate;
                document.getElementById('my-match-pb').innerText = `PB: ${formatTime(s.bestTime.ranked)}`;
                document.getElementById('wr').innerText = (s.wins.ranked + s.loses.ranked) > 0 ? ((s.wins.ranked/(s.wins.ranked + s.loses.ranked))*100).toFixed(1) + "%" : "0.0%";
                document.getElementById('record-pill').innerText = `${s.wins.ranked}W - ${s.loses.ranked}L`;
                document.getElementById('bar-fill').style.width = Math.min((u.eloRate/600)*100, 100) + "%";
                
                const ranks = [[2000,"Netherite","ðŸŸ£"],[1500,"Diamond","ðŸ’Ž"],[1200,"Emerald","â‡ï¸"],[900,"Gold","ðŸŸ¡"],[600,"Iron","âšª"],[400,"Coal III","â¬›"],[200,"Coal II","â¬›"],[0,"Coal I","â¬›"]];
                const r = ranks.find(rk => u.eloRate >= rk[0]);
                document.getElementById('rank-text').innerText = r[1];
                document.getElementById('rank-icon').innerText = r[2];
            }

            if (mRes.status === "success" && mRes.data.length > 0) {
                const m = mRes.data[0];
                const me = m.players.find(p => p.nickname.toLowerCase() === USER.toLowerCase());
                const opp = m.players.find(p => p.nickname.toLowerCase() !== USER.toLowerCase());
                document.getElementById('opp-name').innerText = opp.nickname;
                document.getElementById('opp-pb').innerText = `PB: ${formatTime(opp.statistics?.season?.bestTime?.ranked)}`;
                
                const winnerUUID = m.result.uuid;
                const timeEl = document.getElementById('match-finish-time');
                const myFF = document.getElementById('my-ff');
                const oppFF = document.getElementById('opp-ff');
                
                myFF.style.opacity = "0"; oppFF.style.opacity = "0";

                if (!winnerUUID) {
                    document.getElementById('res-type').innerText = "LAST MATCH: DRAW";
                    document.getElementById('res-type').style.color = "var(--draw)";
                    timeEl.innerText = "";
                } else {
                    const win = winnerUUID === me.uuid;
                    document.getElementById('res-type').innerText = win ? "LAST MATCH: WIN" : "LAST MATCH: LOSS";
                    document.getElementById('res-type').style.color = win ? "var(--win)" : "var(--loss)";
                    timeEl.innerText = formatTime(m.result.time);
                    timeEl.style.color = win ? "var(--win)" : "var(--loss)";
                    if (m.forfeited) { if(win) oppFF.style.opacity = "1"; else myFF.style.opacity = "1"; }
                }
            }
        } catch (e) { console.error(e); }
    }

    function startApp() {
        update();
        setInterval(update, 30000);
    }
</script>
</body>
</html>
